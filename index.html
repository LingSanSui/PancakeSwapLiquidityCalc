<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PancakeSwap V3 ÊµÅÂä®ÊÄßËÆ°ÁÆóÂô®</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .status-panel {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #4CAF50;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-item label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .price-display {
            font-size: 1.5em;
            color: #2196F3;
        }

        .input-section {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .input-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-field input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-field input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .input-with-clear {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-clear input {
            flex: 1;
            padding-right: 40px;
        }

        .clear-btn {
            position: absolute;
            right: 8px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .clear-btn:hover {
            background: #ff5252;
        }

        .clear-btn:active {
            transform: scale(0.95);
        }

        .calc-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .calc-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .calc-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results {
            background: #f0f8ff;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #2196F3;
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.1em;
            color: #2196F3;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
        }

        .update-time {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•û PancakeSwap V3</h1>
            <p>USDT/ZK ÊµÅÂä®ÊÄßÊ±†ËÆ°ÁÆóÂô®</p>
        </div>
        
        <div class="content">
            <div id="errorMsg" class="error" style="display: none;"></div>
            
            <div class="status-panel">
                <h3>üîÑ ÂÆûÊó∂Ê±†Â≠ê‰ø°ÊÅØ</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <label>ÂΩìÂâç‰ª∑Ê†º (USDT/ZK)</label>
                        <div id="currentPrice" class="value price-display">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div class="status-item">
                        <label>ÂΩìÂâç Tick</label>
                        <div id="currentTick" class="value">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div class="status-item">
                        <label>Tick Âå∫Èó¥</label>
                        <div id="tickRange" class="value">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div class="status-item">
                        <label>Âå∫Èó¥‰ª∑Ê†ºËåÉÂõ¥</label>
                        <div id="priceRange" class="value">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
                <div class="update-time" id="updateTime">Êõ¥Êñ∞Êó∂Èó¥: --</div>
            </div>

            <div class="input-section">
                <h3>üí∞ ÊµÅÂä®ÊÄßËÆ°ÁÆó</h3>
                <div class="input-group">
                    <div class="input-field">
                        <label for="usdtAmount">USDT Êï∞Èáè</label>
                        <div class="input-with-clear">
                            <input type="number" id="usdtAmount" placeholder="ËæìÂÖ• USDT Êï∞Èáè" step="0.000001">
                            <button class="clear-btn" onclick="clearInput('usdtAmount')" title="Ê∏ÖÈô§">‚úñ</button>
                        </div>
                    </div>
                    <div class="input-field">
                        <label for="zkAmount">ZK Êï∞Èáè</label>
                        <div class="input-with-clear">
                            <input type="number" id="zkAmount" placeholder="ËæìÂÖ• ZK Êï∞Èáè" step="0.000001">
                            <button class="clear-btn" onclick="clearInput('zkAmount')" title="Ê∏ÖÈô§">‚úñ</button>
                        </div>
                    </div>
                </div>
                <button class="calc-button" onclick="calculateLiquidity()">üßÆ ËÆ°ÁÆóÊµÅÂä®ÊÄß</button>
            </div>

            <div class="results" id="results" style="display: none;">
                <h3>üìä ËÆ°ÁÆóÁªìÊûú</h3>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ÂêàÁ∫¶Âú∞ÂùÄÂíåABI
        const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
        const ZK_ADDRESS = '0xC71B5F631354BE6853eFe9C3Ab6b9590F8302e81';
        
        // BSC RPC URL
        // const RPC_URL = 'https://bsc-dataseed1.binance.org/';
        // const RPC_URL = 'https://pancake-bnb.rpc.blxrbdn.com';
        const RPC_URL = 'https://bsc.nodereal.io';
        // UniswapV3Pool ABI (ÁÆÄÂåñÁâà)
        const POOL_ABI = [
            "function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)",
            "function tickSpacing() external view returns (int24)",
            "function fee() external view returns (uint24)",
            "function token0() external view returns (address)",
            "function token1() external view returns (address)"
        ];

        // PancakeSwap V3 Factory ABI
        const FACTORY_ABI = [
            "function getPool(address tokenA, address tokenB, uint24 fee) external view returns (address pool)"
        ];

        // ERC20 ABI for decimals
        const ERC20_ABI = [
            "function decimals() external view returns (uint8)"
        ];

        const FACTORY_ADDRESS = '0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865'; // PancakeSwap V3 Factory

        let provider;
        let poolContract;
        let currentPoolData = {};
        let updateInterval;
        let token0Address, token1Address;
        let token0Decimals, token1Decimals;
        let isToken0USDT = false;

        // ÂàùÂßãÂåñ
        async function init() {
            try {
                provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                
                // Ëé∑ÂèñÊ±†Â≠êÂú∞ÂùÄ
                const factoryContract = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                const poolAddress = await factoryContract.getPool(USDT_ADDRESS, ZK_ADDRESS, 100); // 0.01% = 100
                
                if (poolAddress === '0x0000000000000000000000000000000000000000') {
                    throw new Error('USDT/ZK 0.01% Ê±†Â≠ê‰∏çÂ≠òÂú®');
                }
                
                poolContract = new ethers.Contract(poolAddress, POOL_ABI, provider);
                
                // Ëé∑Âèñtoken0Âíåtoken1Âú∞ÂùÄ
                token0Address = await poolContract.token0();
                token1Address = await poolContract.token1();
                
                // Á°ÆÂÆöUSDTÊòØtoken0ËøòÊòØtoken1
                isToken0USDT = token0Address.toLowerCase() === USDT_ADDRESS.toLowerCase();
                
                // Ëé∑ÂèñtokenÁ≤æÂ∫¶
                const token0Contract = new ethers.Contract(token0Address, ERC20_ABI, provider);
                const token1Contract = new ethers.Contract(token1Address, ERC20_ABI, provider);
                token0Decimals = await token0Contract.decimals();
                token1Decimals = await token1Contract.decimals();
                
                console.log('Ê±†Â≠êÂú∞ÂùÄ:', poolAddress);
                console.log('Token0:', token0Address, 'Á≤æÂ∫¶:', token0Decimals);
                console.log('Token1:', token1Address, 'Á≤æÂ∫¶:', token1Decimals);
                console.log('USDTÊòØToken0:', isToken0USDT);
                
                // ÂºÄÂßãÂÆöÊúüÊõ¥Êñ∞
                await updatePoolData();
                updateInterval = setInterval(updatePoolData, 2500); // ÊØè2.5ÁßíÊõ¥Êñ∞
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñÈîôËØØ:', error);
                showError('ÂàùÂßãÂåñÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞Ê±†Â≠êÊï∞ÊçÆ
        async function updatePoolData() {
            try {
                const slot0 = await poolContract.slot0();
                const tickSpacing = await poolContract.tickSpacing();
                
                const sqrtPriceX96 = slot0.sqrtPriceX96;
                const currentTick = slot0.tick;
                
                // ËÆ°ÁÆóÂΩìÂâç‰ª∑Ê†º
                const price = calculatePrice(sqrtPriceX96);
                
                // ËÆ°ÁÆótickÂå∫Èó¥
                const { lowerTick, upperTick } = getTickRange(currentTick, tickSpacing);
                
                // ËÆ°ÁÆóÂå∫Èó¥‰ª∑Ê†º
                const lowerPrice = getTickPrice(lowerTick);
                const upperPrice = getTickPrice(upperTick);
                
                // ËΩ¨Êç¢‰∏∫USDT/ZK‰ª∑Ê†ºÊ†ºÂºè
                const currentUsdtZkPrice = isToken0USDT ? 1/price : price;
                const lowerUsdtZkPrice = isToken0USDT ? 1/lowerPrice : lowerPrice;
                const upperUsdtZkPrice = isToken0USDT ? 1/upperPrice : upperPrice;
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('currentPrice').textContent = currentUsdtZkPrice.toFixed(6);
                document.getElementById('currentTick').textContent = currentTick.toString();
                document.getElementById('tickRange').textContent = `${lowerTick} ~ ${upperTick}`;
                document.getElementById('priceRange').textContent = `${Math.min(lowerUsdtZkPrice, upperUsdtZkPrice).toFixed(6)} ~ ${Math.max(lowerUsdtZkPrice, upperUsdtZkPrice).toFixed(6)}`;
                document.getElementById('updateTime').textContent = `Êõ¥Êñ∞Êó∂Èó¥: ${new Date().toLocaleTimeString()}`;
                
                // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆ
                currentPoolData = {
                    sqrtPriceX96,
                    currentTick,
                    tickSpacing,
                    lowerTick,
                    upperTick,
                    price: currentUsdtZkPrice,
                    lowerPrice: Math.min(lowerUsdtZkPrice, upperUsdtZkPrice),
                    upperPrice: Math.max(lowerUsdtZkPrice, upperUsdtZkPrice),
                    rawPrice: price,
                    rawLowerPrice: lowerPrice,
                    rawUpperPrice: upperPrice
                };
                
                hideError();
                
            } catch (error) {
                console.error('Êõ¥Êñ∞Êï∞ÊçÆÈîôËØØ:', error);
                showError('Ëé∑ÂèñÊ±†Â≠êÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // ËÆ°ÁÆó‰ª∑Ê†º‰ªé sqrtPriceX96
        function calculatePrice(sqrtPriceX96) {
            // Â∞Ü sqrtPriceX96 ËΩ¨Êç¢‰∏∫‰ª∑Ê†º
            const Q96 = Math.pow(2, 96);
            const price = Math.pow(sqrtPriceX96.toString() / Q96, 2);
            
            // Ë∞ÉÊï¥Â∞èÊï∞‰ΩçÊï∞Â∑ÆÂºÇ
            const decimalAdjustment = Math.pow(10, token1Decimals - token0Decimals);
            
            return price * decimalAdjustment;
        }

        // ‰ªétickËÆ°ÁÆó‰ª∑Ê†º
        function getTickPrice(tick) {
            const price = Math.pow(1.0001, tick);
            // Ë∞ÉÊï¥Â∞èÊï∞‰ΩçÊï∞Â∑ÆÂºÇ
            const decimalAdjustment = Math.pow(10, token1Decimals - token0Decimals);
            return price * decimalAdjustment;
        }

        // Ëé∑ÂèñtickÂå∫Èó¥
        function getTickRange(currentTick, tickSpacing) {
            const lowerTick = Math.floor(currentTick / tickSpacing) * tickSpacing;
            const upperTick = lowerTick + tickSpacing;
            return { lowerTick, upperTick };
        }

        // ËÆ°ÁÆóÊµÅÂä®ÊÄß
        function calculateLiquidity() {
            const usdtAmount = parseFloat(document.getElementById('usdtAmount').value) || 0;
            const zkAmount = parseFloat(document.getElementById('zkAmount').value) || 0;
            
            if (!currentPoolData.price) {
                showError('ËØ∑Á≠âÂæÖÊ±†Â≠êÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                return;
            }
            
            if (usdtAmount === 0 && zkAmount === 0) {
                showError('ËØ∑ËæìÂÖ• USDT Êàñ ZK Êï∞Èáè');
                return;
            }
            
            const results = [];
            
            // ÂΩìÂâç‰ª∑Ê†ºÂíåtickÂå∫Èó¥
            const currentPrice = currentPoolData.price; // USDT/ZK price
            const lowerPrice = currentPoolData.lowerPrice;
            const upperPrice = currentPoolData.upperPrice;
            
            // V3ÊµÅÂä®ÊÄßËÆ°ÁÆóÔºöÂú®‰ª∑Ê†ºÂå∫Èó¥ÂÜÖËÆ°ÁÆóÊâÄÈúÄÁöÑ‰ª£Â∏ÅÊØî‰æã
            const sqrtCurrentPrice = Math.sqrt(currentPrice);
            const sqrtLowerPrice = Math.sqrt(lowerPrice);
            const sqrtUpperPrice = Math.sqrt(upperPrice);
            
            // ÊÉÖÂÜµ1: Â¶ÇÊûúÂè™ÊúâUSDTÔºàÂ∞ÜÂÖ®ÈÉ®USDTÁî®‰∫éÊ∑ªÂä†ÊµÅÂä®ÊÄßÔºâ
            if (usdtAmount > 0 && zkAmount === 0) {
                let neededZkAmount = 0;
                let swapUsdtAmount = 0;
                let finalUsdtForLiquidity = 0;
                let finalZkForLiquidity = 0;
                
                if (currentPrice <= lowerPrice) {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥‰∏ãÊñπÔºåÈúÄË¶ÅÂÖ®ÈÉ®Êç¢ÊàêZK
                    neededZkAmount = usdtAmount / currentPrice;
                    swapUsdtAmount = usdtAmount;
                    finalUsdtForLiquidity = 0;
                    finalZkForLiquidity = neededZkAmount;
                } else if (currentPrice >= upperPrice) {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥‰∏äÊñπÔºåÂÖ®ÈÉ®USDTÁî®‰∫éÊµÅÂä®ÊÄß
                    neededZkAmount = 0;
                    swapUsdtAmount = 0;
                    finalUsdtForLiquidity = usdtAmount;
                    finalZkForLiquidity = 0;
                } else {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥ÂÜÖÔºåËÆ°ÁÆóÊúÄ‰ºòÂàÜÈÖç
                    const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                    const usdtRatio = ratio;
                    const zkRatio = 1 - ratio;
                    
                    // ËÆ°ÁÆóÈúÄË¶ÅÁöÑÊÄª‰ª∑ÂÄº‰∏≠USDTÂíåZKÁöÑÊØî‰æã
                    const totalValueInUsdt = usdtAmount;
                    finalUsdtForLiquidity = totalValueInUsdt * usdtRatio;
                    const zkValueNeeded = totalValueInUsdt * zkRatio;
                    finalZkForLiquidity = zkValueNeeded / currentPrice;
                    
                    // ÈúÄË¶ÅÁî®Â§öÂ∞ëUSDT‰π∞ZK
                    swapUsdtAmount = zkValueNeeded;
                    neededZkAmount = finalZkForLiquidity;
                }
                
                results.push({
                    label: 'ÊÄªUSDTËµÑ‰∫ß',
                    value: `${usdtAmount.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÈúÄË¶ÅË¥≠‰π∞ÁöÑ ZK Êï∞Èáè',
                    value: `${neededZkAmount.toFixed(6)} ZK`
                });
                results.push({
                    label: 'Áî®‰∫éË¥≠‰π∞ ZK ÁöÑ USDT',
                    value: `${swapUsdtAmount.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ USDT',
                    value: `${finalUsdtForLiquidity.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ ZK',
                    value: `${finalZkForLiquidity.toFixed(6)} ZK`
                });
            }
            
            // ÊÉÖÂÜµ2: Â¶ÇÊûúÂè™ÊúâZKÔºàÂ∞ÜÂÖ®ÈÉ®ZKÁî®‰∫éÊ∑ªÂä†ÊµÅÂä®ÊÄßÔºâ
            else if (zkAmount > 0 && usdtAmount === 0) {
                let neededUsdtAmount = 0;
                let swapZkAmount = 0;
                let finalUsdtForLiquidity = 0;
                let finalZkForLiquidity = 0;
                
                if (currentPrice <= lowerPrice) {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥‰∏ãÊñπÔºåÂÖ®ÈÉ®ZKÁî®‰∫éÊµÅÂä®ÊÄß
                    neededUsdtAmount = 0;
                    swapZkAmount = 0;
                    finalUsdtForLiquidity = 0;
                    finalZkForLiquidity = zkAmount;
                } else if (currentPrice >= upperPrice) {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥‰∏äÊñπÔºåÈúÄË¶ÅÂÖ®ÈÉ®Êç¢ÊàêUSDT
                    neededUsdtAmount = zkAmount * currentPrice;
                    swapZkAmount = zkAmount;
                    finalUsdtForLiquidity = neededUsdtAmount;
                    finalZkForLiquidity = 0;
                } else {
                    // ‰ª∑Ê†ºÂú®Âå∫Èó¥ÂÜÖÔºåËÆ°ÁÆóÊúÄ‰ºòÂàÜÈÖç
                    const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                    const usdtRatio = ratio;
                    const zkRatio = 1 - ratio;
                    
                    // ËÆ°ÁÆóÈúÄË¶ÅÁöÑÊÄª‰ª∑ÂÄº‰∏≠USDTÂíåZKÁöÑÊØî‰æã
                    const totalValueInUsdt = zkAmount * currentPrice;
                    finalUsdtForLiquidity = totalValueInUsdt * usdtRatio;
                    finalZkForLiquidity = totalValueInUsdt * zkRatio / currentPrice;
                    
                    // ÈúÄË¶ÅÂçñÂá∫Â§öÂ∞ëZKÊç¢USDT
                    swapZkAmount = zkAmount - finalZkForLiquidity;
                    neededUsdtAmount = finalUsdtForLiquidity;
                }
                
                results.push({
                    label: 'ÊÄªZKËµÑ‰∫ß',
                    value: `${zkAmount.toFixed(6)} ZK`
                });
                results.push({
                    label: 'ÈúÄË¶ÅÂá∫ÂîÆÁöÑ ZK Êï∞Èáè',
                    value: `${swapZkAmount.toFixed(6)} ZK`
                });
                results.push({
                    label: 'Âá∫ÂîÆ ZK Ëé∑ÂæóÁöÑ USDT',
                    value: `${neededUsdtAmount.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ USDT',
                    value: `${finalUsdtForLiquidity.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ ZK',
                    value: `${finalZkForLiquidity.toFixed(6)} ZK`
                });
            }
            
            // ÊÉÖÂÜµ3: Â¶ÇÊûúÂêåÊó∂ÊúâUSDTÂíåZKÔºàÂ∞ÜÂÖ®ÈÉ®ËµÑ‰∫ßÁî®‰∫éÊ∑ªÂä†ÊµÅÂä®ÊÄßÔºâ
            else if (usdtAmount > 0 && zkAmount > 0) {
                const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                const usdtRatio = Math.max(0, Math.min(1, ratio));
                const zkRatio = 1 - usdtRatio;
                
                // ËÆ°ÁÆóÊÄªËµÑ‰∫ß‰ª∑ÂÄºÔºà‰ª•USDTËÆ°ÁÆóÔºâ
                const totalValueInUsdt = usdtAmount + zkAmount * currentPrice;
                
                // ËÆ°ÁÆóÊúÄ‰ºòÂàÜÈÖç
                const optimalUsdtAmount = totalValueInUsdt * usdtRatio;
                const optimalZkAmount = totalValueInUsdt * zkRatio / currentPrice;
                
                // ËÆ°ÁÆóÈúÄË¶ÅÁöÑ‰∫§Êç¢
                const usdtDiff = optimalUsdtAmount - usdtAmount;
                const zkDiff = optimalZkAmount - zkAmount;
                
                results.push({
                    label: 'ÊÄªËµÑ‰∫ß‰ª∑ÂÄº',
                    value: `${totalValueInUsdt.toFixed(6)} USDT`
                });
                
                if (usdtDiff > 0) {
                    // ÈúÄË¶ÅÊõ¥Â§öUSDTÔºåÂçñÂá∫ZK
                    const zkToSell = Math.abs(zkDiff);
                    results.push({
                        label: 'ÈúÄË¶ÅÂá∫ÂîÆÁöÑ ZK',
                        value: `${zkToSell.toFixed(6)} ZK`
                    });
                    results.push({
                        label: 'Ëé∑ÂæóÁöÑ USDT',
                        value: `${(zkToSell * currentPrice).toFixed(6)} USDT`
                    });
                } else if (zkDiff > 0) {
                    // ÈúÄË¶ÅÊõ¥Â§öZKÔºåÁî®USDTË¥≠‰π∞
                    const usdtToSpend = Math.abs(usdtDiff);
                    results.push({
                        label: 'Áî®‰∫éË¥≠‰π∞ ZK ÁöÑ USDT',
                        value: `${usdtToSpend.toFixed(6)} USDT`
                    });
                    results.push({
                        label: 'Ë¥≠‰π∞ÁöÑ ZK Êï∞Èáè',
                        value: `${zkDiff.toFixed(6)} ZK`
                    });
                } else {
                    results.push({
                        label: 'ËµÑ‰∫ßÊØî‰æãÂ∑≤ÊúÄ‰ºò',
                        value: 'Êó†ÈúÄ‰∫§Êç¢'
                    });
                }
                
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ USDT',
                    value: `${optimalUsdtAmount.toFixed(6)} USDT`
                });
                results.push({
                    label: 'ÊúÄÁªàÊ∑ªÂä†ÊµÅÂä®ÊÄßÁöÑ ZK',
                    value: `${optimalZkAmount.toFixed(6)} ZK`
                });
            }
            
            // Ê∑ªÂä†ÂΩìÂâç‰ª∑Ê†º‰ø°ÊÅØ
            results.unshift({
                label: 'ÂΩìÂâç USDT/ZK ‰ª∑Ê†º',
                value: `${currentPoolData.price.toFixed(6)}`
            });
            
            results.unshift({
                label: 'Tick Âå∫Èó¥‰ª∑Ê†ºËåÉÂõ¥',
                value: `${currentPoolData.lowerPrice.toFixed(6)} ~ ${currentPoolData.upperPrice.toFixed(6)}`
            });
            
            displayResults(results);
        }

        // ÊòæÁ§∫ÁªìÊûú
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultsContent');
            
            let html = '';
            results.forEach(result => {
                html += `
                    <div class="result-item">
                        <div class="result-label">${result.label}</div>
                        <div class="result-value">${result.value}</div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // ÈöêËóèÈîôËØØ
        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // Ê∏ÖÈô§ËæìÂÖ•Ê°Ü
        function clearInput(inputId) {
            document.getElementById(inputId).value = '';
            // ÈöêËóèÁªìÊûú
            document.getElementById('results').style.display = 'none';
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('load', init);
        
        // È°µÈù¢ÂÖ≥Èó≠Êó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 
