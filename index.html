<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PancakeSwap V3 æµåŠ¨æ€§è®¡ç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .status-panel {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #4CAF50;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-item label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .price-display {
            font-size: 1.5em;
            color: #2196F3;
        }

        .input-section {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .input-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-field input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-field input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .calc-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .calc-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .calc-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results {
            background: #f0f8ff;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #2196F3;
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.1em;
            color: #2196F3;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
        }

        .update-time {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ PancakeSwap V3</h1>
            <p>USDT/ZK æµåŠ¨æ€§æ± è®¡ç®—å™¨</p>
        </div>
        
        <div class="content">
            <div id="errorMsg" class="error" style="display: none;"></div>
            
            <div class="status-panel">
                <h3>ğŸ”„ å®æ—¶æ± å­ä¿¡æ¯</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <label>å½“å‰ä»·æ ¼ (USDT/ZK)</label>
                        <div id="currentPrice" class="value price-display">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <label>å½“å‰ Tick</label>
                        <div id="currentTick" class="value">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <label>Tick åŒºé—´</label>
                        <div id="tickRange" class="value">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <label>åŒºé—´ä»·æ ¼èŒƒå›´</label>
                        <div id="priceRange" class="value">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <div class="update-time" id="updateTime">æ›´æ–°æ—¶é—´: --</div>
            </div>

            <div class="input-section">
                <h3>ğŸ’° æµåŠ¨æ€§è®¡ç®—</h3>
                <div class="input-group">
                    <div class="input-field">
                        <label for="usdtAmount">USDT æ•°é‡</label>
                        <input type="number" id="usdtAmount" placeholder="è¾“å…¥ USDT æ•°é‡" step="0.000001">
                    </div>
                    <div class="input-field">
                        <label for="zkAmount">ZK æ•°é‡</label>
                        <input type="number" id="zkAmount" placeholder="è¾“å…¥ ZK æ•°é‡" step="0.000001">
                    </div>
                </div>
                <button class="calc-button" onclick="calculateLiquidity()">ğŸ§® è®¡ç®—æµåŠ¨æ€§</button>
            </div>

            <div class="results" id="results" style="display: none;">
                <h3>ğŸ“Š è®¡ç®—ç»“æœ</h3>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦åœ°å€å’ŒABI
        const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
        const ZK_ADDRESS = '0xC71B5F631354BE6853eFe9C3Ab6b9590F8302e81';
        
        // BSC RPC URL
        const RPC_URL = 'https://pancake-bnb.rpc.blxrbdn.com';
        
        // UniswapV3Pool ABI (ç®€åŒ–ç‰ˆ)
        const POOL_ABI = [
            "function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)",
            "function tickSpacing() external view returns (int24)",
            "function fee() external view returns (uint24)",
            "function token0() external view returns (address)",
            "function token1() external view returns (address)"
        ];

        // PancakeSwap V3 Factory ABI
        const FACTORY_ABI = [
            "function getPool(address tokenA, address tokenB, uint24 fee) external view returns (address pool)"
        ];

        // ERC20 ABI for decimals
        const ERC20_ABI = [
            "function decimals() external view returns (uint8)"
        ];

        const FACTORY_ADDRESS = '0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865'; // PancakeSwap V3 Factory

        let provider;
        let poolContract;
        let currentPoolData = {};
        let updateInterval;
        let token0Address, token1Address;
        let token0Decimals, token1Decimals;
        let isToken0USDT = false;

        // åˆå§‹åŒ–
        async function init() {
            try {
                provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                
                // è·å–æ± å­åœ°å€
                const factoryContract = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                const poolAddress = await factoryContract.getPool(USDT_ADDRESS, ZK_ADDRESS, 100); // 0.01% = 100
                
                if (poolAddress === '0x0000000000000000000000000000000000000000') {
                    throw new Error('USDT/ZK 0.01% æ± å­ä¸å­˜åœ¨');
                }
                
                poolContract = new ethers.Contract(poolAddress, POOL_ABI, provider);
                
                // è·å–token0å’Œtoken1åœ°å€
                token0Address = await poolContract.token0();
                token1Address = await poolContract.token1();
                
                // ç¡®å®šUSDTæ˜¯token0è¿˜æ˜¯token1
                isToken0USDT = token0Address.toLowerCase() === USDT_ADDRESS.toLowerCase();
                
                // è·å–tokenç²¾åº¦
                const token0Contract = new ethers.Contract(token0Address, ERC20_ABI, provider);
                const token1Contract = new ethers.Contract(token1Address, ERC20_ABI, provider);
                token0Decimals = await token0Contract.decimals();
                token1Decimals = await token1Contract.decimals();
                
                console.log('æ± å­åœ°å€:', poolAddress);
                console.log('Token0:', token0Address, 'ç²¾åº¦:', token0Decimals);
                console.log('Token1:', token1Address, 'ç²¾åº¦:', token1Decimals);
                console.log('USDTæ˜¯Token0:', isToken0USDT);
                
                // å¼€å§‹å®šæœŸæ›´æ–°
                await updatePoolData();
                updateInterval = setInterval(updatePoolData, 2500); // æ¯2.5ç§’æ›´æ–°
                
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æ± å­æ•°æ®
        async function updatePoolData() {
            try {
                const slot0 = await poolContract.slot0();
                const tickSpacing = await poolContract.tickSpacing();
                
                const sqrtPriceX96 = slot0.sqrtPriceX96;
                const currentTick = slot0.tick;
                
                // è®¡ç®—å½“å‰ä»·æ ¼
                const price = calculatePrice(sqrtPriceX96);
                
                // è®¡ç®—tickåŒºé—´
                const { lowerTick, upperTick } = getTickRange(currentTick, tickSpacing);
                
                // è®¡ç®—åŒºé—´ä»·æ ¼
                const lowerPrice = getTickPrice(lowerTick);
                const upperPrice = getTickPrice(upperTick);
                
                // è½¬æ¢ä¸ºUSDT/ZKä»·æ ¼æ ¼å¼
                const currentUsdtZkPrice = isToken0USDT ? 1/price : price;
                const lowerUsdtZkPrice = isToken0USDT ? 1/lowerPrice : lowerPrice;
                const upperUsdtZkPrice = isToken0USDT ? 1/upperPrice : upperPrice;
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('currentPrice').textContent = currentUsdtZkPrice.toFixed(6);
                document.getElementById('currentTick').textContent = currentTick.toString();
                document.getElementById('tickRange').textContent = `${lowerTick} ~ ${upperTick}`;
                document.getElementById('priceRange').textContent = `${Math.min(lowerUsdtZkPrice, upperUsdtZkPrice).toFixed(6)} ~ ${Math.max(lowerUsdtZkPrice, upperUsdtZkPrice).toFixed(6)}`;
                document.getElementById('updateTime').textContent = `æ›´æ–°æ—¶é—´: ${new Date().toLocaleTimeString()}`;
                
                // ä¿å­˜å½“å‰æ•°æ®
                currentPoolData = {
                    sqrtPriceX96,
                    currentTick,
                    tickSpacing,
                    lowerTick,
                    upperTick,
                    price: currentUsdtZkPrice,
                    lowerPrice: Math.min(lowerUsdtZkPrice, upperUsdtZkPrice),
                    upperPrice: Math.max(lowerUsdtZkPrice, upperUsdtZkPrice),
                    rawPrice: price,
                    rawLowerPrice: lowerPrice,
                    rawUpperPrice: upperPrice
                };
                
                hideError();
                
            } catch (error) {
                console.error('æ›´æ–°æ•°æ®é”™è¯¯:', error);
                showError('è·å–æ± å­æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // è®¡ç®—ä»·æ ¼ä» sqrtPriceX96
        function calculatePrice(sqrtPriceX96) {
            // å°† sqrtPriceX96 è½¬æ¢ä¸ºä»·æ ¼
            const Q96 = Math.pow(2, 96);
            const price = Math.pow(sqrtPriceX96.toString() / Q96, 2);
            
            // è°ƒæ•´å°æ•°ä½æ•°å·®å¼‚
            const decimalAdjustment = Math.pow(10, token1Decimals - token0Decimals);
            
            return price * decimalAdjustment;
        }

        // ä»tickè®¡ç®—ä»·æ ¼
        function getTickPrice(tick) {
            const price = Math.pow(1.0001, tick);
            // è°ƒæ•´å°æ•°ä½æ•°å·®å¼‚
            const decimalAdjustment = Math.pow(10, token1Decimals - token0Decimals);
            return price * decimalAdjustment;
        }

        // è·å–tickåŒºé—´
        function getTickRange(currentTick, tickSpacing) {
            const lowerTick = Math.floor(currentTick / tickSpacing) * tickSpacing;
            const upperTick = lowerTick + tickSpacing;
            return { lowerTick, upperTick };
        }

        // è®¡ç®—æµåŠ¨æ€§
        function calculateLiquidity() {
            const usdtAmount = parseFloat(document.getElementById('usdtAmount').value) || 0;
            const zkAmount = parseFloat(document.getElementById('zkAmount').value) || 0;
            
            if (!currentPoolData.price) {
                showError('è¯·ç­‰å¾…æ± å­æ•°æ®åŠ è½½å®Œæˆ');
                return;
            }
            
            if (usdtAmount === 0 && zkAmount === 0) {
                showError('è¯·è¾“å…¥ USDT æˆ– ZK æ•°é‡');
                return;
            }
            
            const results = [];
            
            // å½“å‰ä»·æ ¼å’ŒtickåŒºé—´
            const currentPrice = currentPoolData.price; // USDT/ZK price
            const lowerPrice = currentPoolData.lowerPrice;
            const upperPrice = currentPoolData.upperPrice;
            
            // V3æµåŠ¨æ€§è®¡ç®—ï¼šåœ¨ä»·æ ¼åŒºé—´å†…è®¡ç®—æ‰€éœ€çš„ä»£å¸æ¯”ä¾‹
            const sqrtCurrentPrice = Math.sqrt(currentPrice);
            const sqrtLowerPrice = Math.sqrt(lowerPrice);
            const sqrtUpperPrice = Math.sqrt(upperPrice);
            
            // æƒ…å†µ1: å¦‚æœåªæœ‰USDT
            if (usdtAmount > 0 && zkAmount === 0) {
                // è®¡ç®—åœ¨å½“å‰tickåŒºé—´å†…éœ€è¦çš„ZKæ•°é‡
                let neededZkAmount, usdtForLiquidity, zkForLiquidity;
                
                if (currentPrice <= lowerPrice) {
                    // ä»·æ ¼åœ¨åŒºé—´ä¸‹æ–¹ï¼Œåªéœ€è¦ZK
                    neededZkAmount = usdtAmount / lowerPrice;
                    usdtForLiquidity = 0;
                    zkForLiquidity = neededZkAmount;
                } else if (currentPrice >= upperPrice) {
                    // ä»·æ ¼åœ¨åŒºé—´ä¸Šæ–¹ï¼Œåªéœ€è¦USDT
                    neededZkAmount = 0;
                    usdtForLiquidity = usdtAmount;
                    zkForLiquidity = 0;
                } else {
                    // ä»·æ ¼åœ¨åŒºé—´å†…ï¼Œéœ€è¦è®¡ç®—æ¯”ä¾‹
                    const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                    const usdtRatio = ratio;
                    const zkRatio = 1 - ratio;
                    
                    if (zkRatio > 0) {
                        neededZkAmount = (usdtAmount * zkRatio) / (currentPrice * usdtRatio);
                        usdtForLiquidity = usdtAmount * usdtRatio;
                        zkForLiquidity = neededZkAmount;
                    } else {
                        neededZkAmount = 0;
                        usdtForLiquidity = usdtAmount;
                        zkForLiquidity = 0;
                    }
                }
                
                results.push({
                    label: 'éœ€è¦è´­ä¹°çš„ ZK æ•°é‡',
                    value: `${neededZkAmount.toFixed(6)} ZK`
                });
                results.push({
                    label: 'éœ€è¦ç”¨äºè´­ä¹° ZK çš„ USDT',
                    value: `${(neededZkAmount * currentPrice).toFixed(6)} USDT`
                });
                results.push({
                    label: 'æ·»åŠ æµåŠ¨æ€§çš„ USDT',
                    value: `${usdtForLiquidity.toFixed(6)} USDT`
                });
                results.push({
                    label: 'æ·»åŠ æµåŠ¨æ€§çš„ ZK',
                    value: `${zkForLiquidity.toFixed(6)} ZK`
                });
            }
            
            // æƒ…å†µ2: å¦‚æœåªæœ‰ZK
            else if (zkAmount > 0 && usdtAmount === 0) {
                let neededUsdtAmount, usdtForLiquidity, zkForLiquidity;
                
                if (currentPrice <= lowerPrice) {
                    // ä»·æ ¼åœ¨åŒºé—´ä¸‹æ–¹ï¼Œåªéœ€è¦ZK
                    neededUsdtAmount = 0;
                    usdtForLiquidity = 0;
                    zkForLiquidity = zkAmount;
                } else if (currentPrice >= upperPrice) {
                    // ä»·æ ¼åœ¨åŒºé—´ä¸Šæ–¹ï¼Œåªéœ€è¦USDT
                    neededUsdtAmount = zkAmount * upperPrice;
                    usdtForLiquidity = neededUsdtAmount;
                    zkForLiquidity = 0;
                } else {
                    // ä»·æ ¼åœ¨åŒºé—´å†…
                    const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                    const usdtRatio = ratio;
                    const zkRatio = 1 - ratio;
                    
                    if (usdtRatio > 0) {
                        neededUsdtAmount = (zkAmount * usdtRatio * currentPrice) / zkRatio;
                        usdtForLiquidity = neededUsdtAmount;
                        zkForLiquidity = zkAmount * zkRatio;
                    } else {
                        neededUsdtAmount = 0;
                        usdtForLiquidity = 0;
                        zkForLiquidity = zkAmount;
                    }
                }
                
                results.push({
                    label: 'éœ€è¦å‡ºå”®çš„ ZK æ•°é‡è·å¾— USDT',
                    value: `${(neededUsdtAmount / currentPrice).toFixed(6)} ZK`
                });
                results.push({
                    label: 'å‡ºå”® ZK è·å¾—çš„ USDT',
                    value: `${neededUsdtAmount.toFixed(6)} USDT`
                });
                results.push({
                    label: 'æ·»åŠ æµåŠ¨æ€§çš„ USDT',
                    value: `${usdtForLiquidity.toFixed(6)} USDT`
                });
                results.push({
                    label: 'æ·»åŠ æµåŠ¨æ€§çš„ ZK',
                    value: `${zkForLiquidity.toFixed(6)} ZK`
                });
            }
            
            // æƒ…å†µ3: å¦‚æœåŒæ—¶æœ‰USDTå’ŒZK
            else if (usdtAmount > 0 && zkAmount > 0) {
                const ratio = (sqrtCurrentPrice - sqrtLowerPrice) / (sqrtUpperPrice - sqrtLowerPrice);
                const usdtRatio = Math.max(0, Math.min(1, ratio));
                const zkRatio = 1 - usdtRatio;
                
                // è®¡ç®—æœ€ä¼˜æ¯”ä¾‹
                const optimalZkForUsdt = usdtRatio > 0 ? (usdtAmount * zkRatio) / (currentPrice * usdtRatio) : 0;
                const optimalUsdtForZk = zkRatio > 0 ? (zkAmount * usdtRatio * currentPrice) / zkRatio : 0;
                
                if (zkAmount > optimalZkForUsdt && optimalZkForUsdt > 0) {
                    // ZKè¿‡å¤š
                    const excessZk = zkAmount - optimalZkForUsdt;
                    results.push({
                        label: 'å»ºè®®å‡ºå”®çš„å¤šä½™ ZK',
                        value: `${excessZk.toFixed(6)} ZK`
                    });
                } else if (usdtAmount > optimalUsdtForZk && optimalUsdtForZk > 0) {
                    // USDTè¿‡å¤š
                    const excessUsdt = usdtAmount - optimalUsdtForZk;
                    results.push({
                        label: 'å»ºè®®ç”¨å¤šä½™ USDT è´­ä¹° ZK',
                        value: `${(excessUsdt / currentPrice).toFixed(6)} ZK (éœ€è¦ ${excessUsdt.toFixed(6)} USDT)`
                    });
                }
                
                const liquidityUsdt = Math.min(usdtAmount, optimalUsdtForZk || usdtAmount);
                const liquidityZk = Math.min(zkAmount, optimalZkForUsdt || zkAmount);
                
                results.push({
                    label: 'å¯æ·»åŠ æµåŠ¨æ€§çš„ USDT',
                    value: `${liquidityUsdt.toFixed(6)} USDT`
                });
                results.push({
                    label: 'å¯æ·»åŠ æµåŠ¨æ€§çš„ ZK',
                    value: `${liquidityZk.toFixed(6)} ZK`
                });
            }
            
            // æ·»åŠ å½“å‰ä»·æ ¼ä¿¡æ¯
            results.unshift({
                label: 'å½“å‰ USDT/ZK ä»·æ ¼',
                value: `${currentPoolData.price.toFixed(6)}`
            });
            
            results.unshift({
                label: 'Tick åŒºé—´ä»·æ ¼èŒƒå›´',
                value: `${currentPoolData.lowerPrice.toFixed(6)} ~ ${currentPoolData.upperPrice.toFixed(6)}`
            });
            
            displayResults(results);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultsContent');
            
            let html = '';
            results.forEach(result => {
                html += `
                    <div class="result-item">
                        <div class="result-label">${result.label}</div>
                        <div class="result-value">${result.value}</div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html> 
